name: Tests

on:
  push:
    branches: [main, ci-dev]
  pull_request:
    branches: [main, "feature/**"]
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: "Run the build wit tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)"
        required: false
        default: false
      debug_os:
        type: choice
        description: "Select OS where tmate debug session should run"
        required: false
        default: ubuntu-24.04
        options:
          - ubuntu-24.04
          - macos-14
          - macos-15

jobs:
  # -------------------------------------------------------
  # Formal checks (formatting + linting)
  # -------------------------------------------------------
  lint:
    name: Formal Checks (Linux)
    runs-on: ubuntu-24.04

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y shellcheck shfmt

      - name: ğŸ” Run formal checks
        run: |
          echo "Running ./build check..."
          ./build check

  # -------------------------------------------------------
  # Bats test suite across OS versions
  # -------------------------------------------------------
  test:
    name: Bats Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        # os: tests on ubuntu-22.04 fail since bats is too old
        os: [ubuntu-24.04, macos-14, macos-15]

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Install dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update -y
            sudo apt-get install -y bats
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew update
            brew install bats-core
          fi

      - name: ğŸ§ª Run Bats tests
        run: |
          echo "Running Bats tests..."
          bats --version
          bats test
      - name: ğŸ Start tmate session (manual trigger only)
        if: |
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.debug_enabled == 'true' &&
          matrix.os == github.event.inputs.debug_os
        uses: mxschmitt/action-tmate@v3
