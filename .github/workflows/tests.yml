name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, "feature/**"]
  workflow_dispatch:

permissions:
  pull-requests: write

jobs:
  # -------------------------------------------------------
  # Formal checks (formatting + linting)
  # -------------------------------------------------------
  lint:
    name: Formal Checks (Linux)
    runs-on: ubuntu-24.04

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y shellcheck shfmt
          curl -LsSf https://github.com/rvben/rumdl/releases/download/v0.0.181/rumdl-v0.0.181-x86_64-unknown-linux-gnu.tar.gz | sudo tar xzf - -C /usr/local/bin

      - name: ğŸ” Run formal checks
        run: |
          # Disable link check since this is done later
          echo "Running ./build check ..."
          ./build check --skip-link

      - name: ğŸ” Checks for broken links
        uses: lycheeverse/lychee-action@v2

      - name: Comment broken links
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: lychee/out.md

  # -------------------------------------------------------
  # Bats test suite across OS versions
  # -------------------------------------------------------
  test:
    name: Bats Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        # Tests on ubuntu-22.04 fail since bats is too old
        os: [ubuntu-24.04, macos-14, macos-15]

    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Install dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update -y
            sudo apt-get install -y bats
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew update
            brew install bats-core
          fi

      - name: ğŸ§ª Run Bats tests
        run: |
          echo "Running Bats tests..."
          bats --version
          bats test --print-output-on-failure
      - name: ğŸ Start tmate session (manual trigger only)
        if: |
          github.event_name == 'workflow_dispatch' &&
          github.event.inputs.debug_enabled == 'true' &&
          matrix.os == github.event.inputs.debug_os
        uses: mxschmitt/action-tmate@v3
